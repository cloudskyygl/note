参考:

https://help.ubuntu.com/community/IptablesHowTo

https://wiki.archlinux.org/index.php/iptables

https://wiki.archlinux.org/index.php/Simple_stateful_firewall

https://en.wikipedia.org/wiki/Iptables


环境:

iptables v1.6.0 on Ubuntu 16.04.3

iptables v1.4.7 on CentOS 6.9

只操作 filter 表


## 从命令行

### 查看当前规则

```
# iptables -nvL # L 必须放在各个选项的最后
```

### 重置规则

```
# iptables -F # 删除 filter 表中所有链上的所有的规则,不删除链
# iptables -X # 删除 filter 表中所有用户自定义链,链必须为空且不被引用
```

对于其他表清除规则和自定义链，需加上 ```-t``` 选项指定相应的表

若当前正处于 SSH 连接，先允许 22 端口访问

```
# iptables -A INPUT -p tcp --dport 22 -j ACCEPT
```

还需要设置链的默认策略，当然默认表为 filter

```
# iptables -P INPUT DROP
# iptables -P FORWARD DROP
# iptables -P OUTPUT ACCEPT
```

** policy target 必须为 ACCEPT 或 DROP。 **


### 编辑规则

创建两条用户定义的链，用于打开防火墙的端口

```
# iptables -N TCP
# iptables -N UDP
```

添加到INPUT链中的第一条规则将允许属于已建立连接的通信，或与这些连接相关的新的有效通信（如ICMP错误）
或回显应答（主机在ping时返回的数据包）

```
# iptables -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
```

第二条规则将接受来自“loopback”（lo）接口的所有流量，这对于许多应用和服务是必需的。

```
# iptables -A INPUT -i lo -j ACCEPT
```

第三条规则将丢掉具有“INVALID”状态匹配的数据包。 可以分为四个“状态”类别：新的，已建立的，相关的或无效的，这就是使它成为一个“有状态”的防火墙而不是安全的“无状态”。 使用“nf_conntrack_ \*”内核模块来跟踪状态，这些内核模块在添加规则时由内核自动加载。

```
# iptables -A INPUT -m conntrack --ctstate INVALID -j DROP
```

下一个规则将接受所有新的传入的ICMP回显请求，也称为ping。 只有第一个数据包将被计为NEW，其余的将被相关的ESTABLISHED规则处理。 由于计算机不是路由器，因此不需要允许具有状态NEW的其他ICMP流量。

```
iptables -A INPUT -p icmp --icmp-type 8 -m conntrack --ctstate NEW -j ACCEPT
```

我们将TCP和UDP链附加到INPUT链以处理所有新的传入连接。 一旦连接被TCP或UDP链接受，它由 RELATED/ESTABLISHED 流量规则处理。 TCP和UDP链将接受新的传入连接，或礼貌地拒绝它们。 必须使用SYN数据包启动新的TCP连接。

```
# iptables -A INPUT -p udp -m conntrack --ctstate NEW -j UDP
# iptables -A INPUT -p tcp --syn -m conntrack --ctstate NEW -j TCP
```

如果端口未打开，我们拒绝TCP TCP数据包和UDP流的TCP连接，ICMP端口不可达消息。 这模仿默认的Linux行为（符合RFC），并允许发件人快速关闭连接并清理。

```
# iptables -A INPUT -p udp -j REJECT --reject-with icmp-port-unreachable
# iptables -A INPUT -p tcp -j REJECT --reject-with tcp-rst
```

对于其他协议，我们向INPUT链添加最终规则，以通过icmp协议不可达消息来拒绝所有剩余的传入流量。这模仿Linux的默认行为。

```
# iptables -A INPUT -j REJECT --reject-with icmp-proto-unreachable
```

* TCP 和 UDP 链

接受Web服务器端口80上的传入的TCP连接

```
# iptables -A TCP -p tcp --dport 80 -j ACCEPT
```

接受在HTTPS端口443上传入的TCP连接

```
# iptables -A TCP -p tcp --dport 443 -j ACCEPT
```

允许远程SSH连接（在端口22上）

```
# iptables -A TCP -p tcp --dport 22 -j ACCEPT
```

在端口53上接收DNS服务器的传入UDP流

```
# iptables -A UDP -p udp --dport 53 -j ACCEPT
```


## 配置文件

将规则保存到文件中，以使永久生效。

* CentOS 6.9

```terminal
$ sudo /etc/init.d/iptables save
```
或者
```terminal
$ sudo service iptables save
```

与 Ubuntu 相比，下面的命令在 CentOS 上是不能执行成功的

```terminal
$ sudo sh -c "iptables-save -c > /etc/sysconfig/iptables"
```

只能切换到 root 用户中执行

* Ubuntu

```terminal
$ sudo sh -c "iptables-save -c > /etc/iptables.rules"
```

下面是一个简单的防火墙规则文件的样例

```config
# Generated by iptables-save v1.4.7 on Wed Aug 23 03:13:40 2017
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [110:15439]
:TCP - [0:0]
:UDP - [0:0]
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -m conntrack --ctstate INVALID -j DROP
-A INPUT -p icmp -m icmp --icmp-type 8 -m conntrack --ctstate NEW -j ACCEPT
-A INPUT -p udp -m conntrack --ctstate NEW -j UDP
-A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -m conntrack --ctstate NEW -j TCP
-A INPUT -p udp -j REJECT --reject-with icmp-port-unreachable
-A INPUT -p tcp -j REJECT --reject-with tcp-reset
-A INPUT -j REJECT --reject-with icmp-proto-unreachable
-A TCP -p tcp -m tcp --dport 22 -j ACCEPT
-A UDP -p udp -m udp --dport 53 -j ACCEPT
COMMIT
# Completed on Wed Aug 23 03:13:40 2017
```
